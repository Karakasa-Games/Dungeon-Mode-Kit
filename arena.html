<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Combat Arena - Balance Testing</title>
    <link rel="stylesheet" href="assets/main.css" type="text/css" media="screen" charset="utf-8">
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            margin: 0;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #84DCCF;
            margin: 0 0 10px 0;
        }
        h1 { font-size: 1.5em; }
        h2 { font-size: 1.2em; color: #EC7505; }
        h3 { font-size: 1em; color: #aaa; margin-top: 15px; }

        .arena-layout {
            display: flex;
            gap: 20px;
            max-width: 1400px;
        }

        .game-panel {
            flex: 0 0 auto;
        }

        .controls-panel {
            flex: 1;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .stat-editor {
            background: #16213e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .stat-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .stat-row label {
            flex: 0 0 100px;
            font-size: 0.9em;
            color: #aaa;
        }

        .stat-row input {
            flex: 1;
            max-width: 80px;
            padding: 5px 8px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #2d2d44;
            color: #fff;
            font-size: 0.9em;
        }

        .stat-row input:focus {
            outline: none;
            border-color: #84DCCF;
        }

        .stat-row .current-value {
            flex: 0 0 60px;
            font-size: 0.85em;
            color: #666;
            text-align: right;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }

        button.primary {
            background: #84DCCF;
            color: #1a1a2e;
        }
        button.primary:hover {
            background: #6bc4b8;
        }

        button.secondary {
            background: #444;
            color: #fff;
        }
        button.secondary:hover {
            background: #555;
        }

        button.danger {
            background: #c44;
            color: #fff;
        }
        button.danger:hover {
            background: #a33;
        }

        .combat-log {
            background: #0d1117;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.8em;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-entry {
            margin-bottom: 4px;
            padding: 2px 0;
            border-bottom: 1px solid #222;
        }
        .log-hit { color: #4a4; }
        .log-miss { color: #a44; }
        .log-damage { color: #ec7505; }
        .log-proc { color: #84DCCF; }

        .formula-display {
            background: #2d2d44;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
            margin: 10px 0;
        }

        .hit-preview {
            color: #84DCCF;
            font-weight: bold;
        }

        .damage-preview {
            color: #ec7505;
            font-weight: bold;
        }

        #status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        #status.success { background: #1a4a1a; color: #4a4; }
        #status.error { background: #4a1a1a; color: #f44; }

        .instructions {
            background: #16213e;
            border-left: 3px solid #84DCCF;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .collapsible {
            cursor: pointer;
            user-select: none;
        }
        .collapsible::before {
            content: '+ ';
            color: #84DCCF;
        }
        .collapsible.open::before {
            content: '- ';
        }
        .collapsible-content {
            display: none;
        }
        .collapsible-content.open {
            display: block;
        }

        /* Override game container for side-by-side layout */
        .game-container {
            flex-direction: column !important;
        }
    </style>
</head>
<body>
    <h1>Combat Arena - Balance Testing</h1>
    <p id="status">Loading...</p>

    <div class="arena-layout">
        <div class="game-panel">
            <div class="game-container">
                <div id="game" data-prototype="arena"></div>
                <div class="text">
                    <div id="actors" class="actor-list"></div>
                    <div id="items" class="item-list"></div>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="instructions">
                <strong>Controls:</strong> Arrow keys or WASD to move. Bump into enemies to attack.<br>
                <strong>Inventory:</strong> Press 'i' to open inventory, equip weapons/armor.<br>
                <strong>Testing:</strong> Modify stats below and click "Apply" to update live actors.
            </div>

            <!-- Player Stats -->
            <div class="stat-editor" id="player-editor">
                <h2>Player Stats</h2>
                <div class="stat-row">
                    <label>Health</label>
                    <input type="number" id="player-health" value="100" min="1">
                    <span class="current-value" id="player-health-current"></span>
                </div>
                <div class="stat-row">
                    <label>Strength</label>
                    <input type="number" id="player-strength" value="10" min="1">
                    <span class="current-value" id="player-strength-current"></span>
                </div>
                <div class="stat-row">
                    <label>Accuracy</label>
                    <input type="number" id="player-accuracy" value="70" min="0" max="100">
                    <span class="current-value" id="player-accuracy-current"></span>
                </div>
                <div class="stat-row">
                    <label>Defense</label>
                    <input type="number" id="player-defense" value="5" min="0">
                    <span class="current-value" id="player-defense-current"></span>
                </div>
                <div class="button-row">
                    <button class="primary" onclick="applyPlayerStats()">Apply</button>
                    <button class="secondary" onclick="healPlayer()">Full Heal</button>
                </div>
            </div>

            <!-- Minotaur Stats -->
            <div class="stat-editor" id="minotaur-editor">
                <h2>Minotaur Stats</h2>
                <div class="stat-row">
                    <label>Health</label>
                    <input type="number" id="minotaur-health" value="80" min="1">
                    <span class="current-value" id="minotaur-health-current"></span>
                </div>
                <div class="stat-row">
                    <label>Strength</label>
                    <input type="number" id="minotaur-strength" value="12" min="1">
                    <span class="current-value" id="minotaur-strength-current"></span>
                </div>
                <div class="stat-row">
                    <label>Accuracy</label>
                    <input type="number" id="minotaur-accuracy" value="80" min="0" max="100">
                    <span class="current-value" id="minotaur-accuracy-current"></span>
                </div>
                <div class="stat-row">
                    <label>Defense</label>
                    <input type="number" id="minotaur-defense" value="15" min="0">
                    <span class="current-value" id="minotaur-defense-current"></span>
                </div>
                <div class="button-row">
                    <button class="primary" onclick="applyMinotaurStats()">Apply</button>
                    <button class="secondary" onclick="healMinotaur()">Full Heal</button>
                    <button class="secondary" onclick="respawnMinotaur()">Respawn</button>
                </div>
            </div>

            <!-- Combat Calculator -->
            <div class="stat-editor">
                <h2>Combat Calculator</h2>
                <h3>Player vs Minotaur</h3>
                <div class="formula-display" id="player-vs-minotaur">
                    Loading...
                </div>
                <h3>Minotaur vs Player</h3>
                <div class="formula-display" id="minotaur-vs-player">
                    Loading...
                </div>
                <div class="button-row">
                    <button class="secondary" onclick="updateCalculator()">Recalculate</button>
                </div>
            </div>

            <!-- Weapon Editor -->
            <div class="stat-editor">
                <h3 class="collapsible" onclick="toggleSection(this)">Weapon Base Damage</h3>
                <div class="collapsible-content">
                    <div class="stat-row">
                        <label>Sword</label>
                        <input type="number" id="weapon-sword" value="-10" max="0">
                    </div>
                    <div class="stat-row">
                        <label>Warhammer</label>
                        <input type="number" id="weapon-warhammer" value="-8" max="0">
                    </div>
                    <div class="stat-row">
                        <label>Vampiric Blade</label>
                        <input type="number" id="weapon-vampiric_blade" value="-6" max="0">
                    </div>
                    <div class="stat-row">
                        <label>Assassin Dagger</label>
                        <input type="number" id="weapon-assassin_dagger" value="-4" max="0">
                    </div>
                    <div class="button-row">
                        <button class="primary" onclick="applyWeaponStats()">Apply Weapon Changes</button>
                    </div>
                </div>
            </div>

            <!-- Combat Log -->
            <div class="stat-editor">
                <h3 class="collapsible open" onclick="toggleSection(this)">Combat Log</h3>
                <div class="collapsible-content open">
                    <div class="combat-log" id="combat-log">
                        Combat events will appear here...
                    </div>
                    <div class="button-row">
                        <button class="secondary" onclick="clearLog()">Clear Log</button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="stat-editor">
                <h2>Quick Actions</h2>
                <div class="button-row">
                    <button class="danger" onclick="reloadArena()">Restart Arena</button>
                    <button class="secondary" onclick="exportConfig()">Export Config</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="lib/rot.js"></script>
    <script src="lib/pixi.min.js"></script>
    <script src="lib/tweenjs.js"></script>
    <script src="lib/howler.js"></script>
    <script src="globals.js"></script>
    <script src="architect.js"></script>
    <script src="lighting.js"></script>
    <script src="sound.js"></script>
    <script src="interface.js"></script>
    <script src="input.js"></script>
    <script src="engine.js"></script>

    <script>
        const statusEl = document.getElementById('status');
        const combatLogEl = document.getElementById('combat-log');
        let updateInterval;

        function updateStatus(message, isError = false) {
            statusEl.textContent = message;
            statusEl.className = isError ? 'error' : 'success';
        }

        // Find actors by name
        function findPlayer() {
            if (!engine || !engine.entityManager) return null;
            return engine.entityManager.actors.find(a => a.isPlayerControlled?.());
        }

        function findMinotaur() {
            if (!engine || !engine.entityManager) return null;
            return engine.entityManager.actors.find(a =>
                a.name === 'Asterion' || a.name?.toLowerCase().includes('minotaur')
            );
        }

        function findActorByName(name) {
            if (!engine || !engine.entityManager) return null;
            return engine.entityManager.actors.find(a => a.name === name);
        }

        // Apply stats to player
        function applyPlayerStats() {
            const player = findPlayer();
            if (!player) {
                logCombat('Player not found!', 'miss');
                return;
            }

            const health = parseInt(document.getElementById('player-health').value);
            const strength = parseInt(document.getElementById('player-strength').value);
            const accuracy = parseInt(document.getElementById('player-accuracy').value);
            const defense = parseInt(document.getElementById('player-defense').value);

            // Update stats
            if (player.stats.health) {
                player.stats.health.max = health;
                player.stats.health.current = Math.min(player.stats.health.current, health);
            }
            player.setAttribute('strength', strength);
            player.setAttribute('accuracy', accuracy);
            player.setAttribute('defense', defense);

            engine.interfaceManager?.updatePlayerInfo();
            logCombat(`Player stats updated: STR=${strength}, ACC=${accuracy}, DEF=${defense}`, 'proc');
            updateCalculator();
            updateCurrentValues();
        }

        function healPlayer() {
            const player = findPlayer();
            if (!player || !player.stats.health) return;
            player.stats.health.current = player.stats.health.max;
            engine.interfaceManager?.updatePlayerInfo();
            logCombat('Player fully healed!', 'proc');
            updateCurrentValues();
        }

        // Apply stats to minotaur
        function applyMinotaurStats() {
            const minotaur = findMinotaur();
            if (!minotaur) {
                logCombat('Minotaur not found!', 'miss');
                return;
            }

            const health = parseInt(document.getElementById('minotaur-health').value);
            const strength = parseInt(document.getElementById('minotaur-strength').value);
            const accuracy = parseInt(document.getElementById('minotaur-accuracy').value);
            const defense = parseInt(document.getElementById('minotaur-defense').value);

            if (minotaur.stats.health) {
                minotaur.stats.health.max = health;
                minotaur.stats.health.current = Math.min(minotaur.stats.health.current, health);
            }
            minotaur.setAttribute('strength', strength);
            minotaur.setAttribute('accuracy', accuracy);
            minotaur.setAttribute('defense', defense);

            logCombat(`Minotaur stats updated: STR=${strength}, ACC=${accuracy}, DEF=${defense}`, 'proc');
            updateCalculator();
            updateCurrentValues();
        }

        function healMinotaur() {
            const minotaur = findMinotaur();
            if (!minotaur || !minotaur.stats.health) return;
            minotaur.stats.health.current = minotaur.stats.health.max;
            logCombat('Minotaur fully healed!', 'proc');
            updateCurrentValues();
        }

        function respawnMinotaur() {
            if (!engine || !engine.entityManager) return;

            // Remove all existing minotaurs first
            const existingMinotaurs = engine.entityManager.actors.filter(a =>
                a.name === 'Asterion' || a.name?.toLowerCase().includes('minotaur')
            );
            for (const minotaur of existingMinotaurs) {
                engine.entityManager.removeEntity(minotaur);
            }

            // Find a random passable position
            const width = engine.architect?.width || 25;
            const height = engine.architect?.height || 20;
            let x, y, attempts = 0;
            do {
                x = Math.floor(Math.random() * (width - 4)) + 2;
                y = Math.floor(Math.random() * (height - 4)) + 2;
                attempts++;
            } while ((!engine.isPassable(x, y) || engine.getActorAt(x, y)) && attempts < 100);

            engine.entityManager.spawnActor('minotaur', x, y);
            logCombat('Minotaur respawned!', 'proc');
            updateCurrentValues();
        }

        // Apply weapon damage changes
        function applyWeaponStats() {
            if (!engine || !engine.entityManager) return;

            const weapons = {
                'sword': parseInt(document.getElementById('weapon-sword').value),
                'warhammer': parseInt(document.getElementById('weapon-warhammer').value),
                'vampiric_blade': parseInt(document.getElementById('weapon-vampiric_blade').value),
                'assassin_dagger': parseInt(document.getElementById('weapon-assassin_dagger').value)
            };

            // Update global item definitions
            for (const [weaponId, damage] of Object.entries(weapons)) {
                if (engine.globalItems[weaponId]) {
                    engine.globalItems[weaponId].attributes.collision_effect = { health: damage };
                }
            }

            // Update existing items in the world
            for (const item of engine.entityManager.items) {
                const id = item.type || item.name?.toLowerCase().replace(/[^a-z_]/g, '_');
                if (weapons[id] !== undefined) {
                    item.setAttribute('collision_effect', { health: weapons[id] });
                }
            }

            // Update items in inventories
            for (const actor of engine.entityManager.actors) {
                if (actor.inventory) {
                    for (const item of actor.inventory) {
                        const id = item.type || item.name?.toLowerCase().replace(/[^a-z_]/g, '_');
                        if (weapons[id] !== undefined) {
                            item.setAttribute('collision_effect', { health: weapons[id] });
                        }
                    }
                }
            }

            logCombat('Weapon damage values updated!', 'proc');
            updateCalculator();
        }

        // Combat calculator
        function updateCalculator() {
            const player = findPlayer();
            const minotaur = findMinotaur();

            // Player vs Minotaur
            const pvmEl = document.getElementById('player-vs-minotaur');
            if (player && minotaur) {
                const pAcc = player.getEffectiveAccuracy?.() || player.getAttribute('accuracy') || 70;
                const mDef = minotaur.getEffectiveDefense?.() || minotaur.getAttribute('defense') || 0;
                const pStr = player.getEffectiveStrength?.() || player.getAttribute('strength') || 10;

                const hitChance = Math.max(5, Math.min(95, Math.round(pAcc * Math.pow(0.987, mDef))));

                // Get weapon damage
                const weapon = player.equipment?.weapon;
                const baseDamage = weapon?.getAttribute('collision_effect')?.health ||
                                   player.getAttribute('collision_effect')?.health || -2;
                const scaledDamage = Math.round(Math.abs(baseDamage) * (pStr / 10));

                pvmEl.innerHTML = `
                    Hit: <span class="hit-preview">${hitChance}%</span> = ${pAcc} × 0.987^${mDef}<br>
                    Dmg: <span class="damage-preview">${scaledDamage}</span> = ${Math.abs(baseDamage)} × ${pStr}/10
                `;
            } else {
                pvmEl.textContent = 'Player or Minotaur not found';
            }

            // Minotaur vs Player
            const mvpEl = document.getElementById('minotaur-vs-player');
            if (player && minotaur) {
                const mAcc = minotaur.getEffectiveAccuracy?.() || minotaur.getAttribute('accuracy') || 80;
                const pDef = player.getEffectiveDefense?.() || player.getAttribute('defense') || 0;
                const mStr = minotaur.getEffectiveStrength?.() || minotaur.getAttribute('strength') || 12;

                const hitChance = Math.max(5, Math.min(95, Math.round(mAcc * Math.pow(0.987, pDef))));

                const baseDamage = minotaur.getAttribute('collision_effect')?.health || -8;
                const scaledDamage = Math.round(Math.abs(baseDamage) * (mStr / 10));

                mvpEl.innerHTML = `
                    Hit: <span class="hit-preview">${hitChance}%</span> = ${mAcc} × 0.987^${pDef}<br>
                    Dmg: <span class="damage-preview">${scaledDamage}</span> = ${Math.abs(baseDamage)} × ${mStr}/10
                `;
            } else {
                mvpEl.textContent = 'Player or Minotaur not found';
            }
        }

        // Update current value displays
        function updateCurrentValues() {
            const player = findPlayer();
            const minotaur = findMinotaur();

            if (player) {
                const hp = player.stats?.health;
                document.getElementById('player-health-current').textContent =
                    hp ? `(${hp.current}/${hp.max})` : '';
                document.getElementById('player-strength-current').textContent =
                    `(${player.getEffectiveStrength?.() || player.getAttribute('strength') || 10})`;
                document.getElementById('player-accuracy-current').textContent =
                    `(${player.getEffectiveAccuracy?.() || player.getAttribute('accuracy') || '?'})`;
                document.getElementById('player-defense-current').textContent =
                    `(${player.getEffectiveDefense?.() || player.getAttribute('defense') || 0})`;
            }

            if (minotaur && !minotaur.isDead) {
                const hp = minotaur.stats?.health;
                document.getElementById('minotaur-health-current').textContent =
                    hp ? `(${hp.current}/${hp.max})` : '';
                document.getElementById('minotaur-strength-current').textContent =
                    `(${minotaur.getEffectiveStrength?.() || minotaur.getAttribute('strength') || 12})`;
                document.getElementById('minotaur-accuracy-current').textContent =
                    `(${minotaur.getEffectiveAccuracy?.() || minotaur.getAttribute('accuracy') || 80})`;
                document.getElementById('minotaur-defense-current').textContent =
                    `(${minotaur.getEffectiveDefense?.() || minotaur.getAttribute('defense') || 15})`;
            } else {
                document.getElementById('minotaur-health-current').textContent = '(DEAD)';
            }
        }

        // Combat log
        function logCombat(message, type = '') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            combatLogEl.appendChild(entry);
            combatLogEl.scrollTop = combatLogEl.scrollHeight;
        }

        function clearLog() {
            combatLogEl.innerHTML = '';
        }

        // Hook into console.log to capture combat messages
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const msg = args.join(' ');
            if (msg.includes('Hit roll:')) {
                const isHit = msg.includes('= HIT');
                logCombat(msg, isHit ? 'hit' : 'miss');
            } else if (msg.includes('Strength scaling:')) {
                logCombat(msg, 'damage');
            } else if (msg.includes('Critical hit') || msg.includes('Knockback:') || msg.includes('Lifesteal:')) {
                logCombat(msg, 'proc');
            }
        };

        // UI helpers
        function toggleSection(el) {
            el.classList.toggle('open');
            const content = el.nextElementSibling;
            content.classList.toggle('open');
        }

        function reloadArena() {
            if (engine) {
                engine.reloadPrototype('arena');
                logCombat('Arena reloaded!', 'proc');
                setTimeout(() => {
                    updateCurrentValues();
                    updateCalculator();
                }, 500);
            }
        }

        function exportConfig() {
            const player = findPlayer();
            const minotaur = findMinotaur();

            const config = {
                player: player ? {
                    health: player.stats?.health?.max,
                    strength: player.getAttribute('strength'),
                    accuracy: player.getAttribute('accuracy'),
                    defense: player.getAttribute('defense')
                } : null,
                minotaur: minotaur ? {
                    health: minotaur.stats?.health?.max,
                    strength: minotaur.getAttribute('strength'),
                    accuracy: minotaur.getAttribute('accuracy'),
                    defense: minotaur.getAttribute('defense')
                } : null,
                weapons: {
                    sword: parseInt(document.getElementById('weapon-sword').value),
                    warhammer: parseInt(document.getElementById('weapon-warhammer').value),
                    vampiric_blade: parseInt(document.getElementById('weapon-vampiric_blade').value),
                    assassin_dagger: parseInt(document.getElementById('weapon-assassin_dagger').value)
                }
            };

            const json = JSON.stringify(config, null, 2);
            console.log('Current Config:', json);

            // Copy to clipboard
            navigator.clipboard?.writeText(json).then(() => {
                logCombat('Config copied to clipboard!', 'proc');
            }).catch(() => {
                logCombat('Config logged to console (clipboard not available)', 'proc');
            });
        }

        // Initialize
        async function startArena() {
            try {
                updateStatus('Initializing arena...');
                await initializeGame();
                updateStatus('Arena loaded! Use controls on the right to adjust stats.');

                // Start periodic updates
                updateInterval = setInterval(() => {
                    updateCurrentValues();
                }, 500);

                // Initial update
                setTimeout(() => {
                    updateCurrentValues();
                    updateCalculator();
                }, 500);

            } catch (e) {
                updateStatus(`Error: ${e.message}`, true);
                console.error(e);
            }
        }

        window.addEventListener('load', () => {
            setTimeout(startArena, 500);
        });
    </script>
</body>
</html>
